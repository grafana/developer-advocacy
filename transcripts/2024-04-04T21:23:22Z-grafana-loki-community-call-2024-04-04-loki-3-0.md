# Grafana Loki Community Call 2024-04-04: Loki 3.0!!!

In this month's installment of the Grafana Loki Community call, we talk about what's coming in Loki 3.0!!! Set for release next week!

Published on 2024-04-04T21:23:22Z

URL: https://www.youtube.com/watch?v=lwaT6LkMt8c

Transcript: all right welcome to April 4th Loki Community call um particularly uh I don't know excited and excitable this week because we are in a Mad Dash to finish uh 3.0 release for next week so 3.0 is not really a secret at this point we talked about it I don't know couple weeks ago at least uh and yeah it's been an adventure the last few months but um we are full steam ahead on releasing 3.04 uh basically for next week uh to coincide with graphicon um let me share my screen here so the only thing on the agenda today that really I had to talk about was 3.0 itself um anybody wants to add anything else please feel free to uh but we'll kind of go down through uh talk about these features a bit and uh I don't know I want to kind of talk about expectations a little bit because not everything is exactly where we were hoping it would be but there's lots of good stuff in this release so yeah Owen you're are expert on Bloom filters which is kind of the scary thought Corner Stone um yeah tell us tell us about it tell us about uh what they are and yeah I'm sure so there's gonna be a I'm preparing a talk for next week agronic con which will kind of go into this stuff a little bit uh more in depth and have some nice graphics and things like that um but yes so we've been working on a a bloom filters Edition in dooki for um I I started specking out the idea like six months ago um and we're going to release kind of an experimental preview of that with 3.0 um it's certainly not it's it's you know we're at the make it work stage not the you know make it not make it fast make it cheap you know make it elegant none of those things yet but um it should be you can play around with it basically the idea here is um let's see if I can do the the 20 second elevator pitch um balloon filters probabilistic data structure very space efficient um we mix that with um kind of technique called engrams which are just sequential sets of characters and so we basically it allows us to kind of index or store everything in log lines in blo filters um and then you can kind of reconstitute queries particularly filter expressions and check the balloon filters for um the engrams that constitute the filter expression and then potentially you know remove a lot of data they fil pre-filter out a bunch of chunks that you wouldn't need to query because you can guarantee that they won't match your query so that's really attractive as um we start seeing a lot of people go from using Loki as a very very targeted Search tool to a tool where um it's very common now for people to send a lot of uh kind of very broad label selectors but looking for stuff like you know a transaction ID or you know a support a u ID referencing a support case things like that and so the idea here is that we can use that to filter out a lot of data not need to query it because at some point it stops becoming efficient to query huge swats of data Loki is always you know for years we basically focus on making Loki you know higher scale faster processing data but now we're really starting to a little bit and focus on reducing the need to do that when when we when we can um and so this is particularly kind of opens up some newer um make certain types of queries a lot more feasible now but it should also just work in general with to accelerate queries that that use filter expression which is you know pretty much all of them yeah needle and hyack the word I didn't mention but that's kind of the most that's the type of query where you'll see a huge amount of benefit from this um so we've been running this um ourselves for while um seeing up to around you know maybe 90% filter rates on these s of uid queries still think there's a lot of room to push that up but all things in good time room wasn't built in day yada yada yeah so um yeah super excited about this because we you know we run a lot of Loki and um when we did some stats on this in the fall it was you know nearly 70% of the time our queriers spend executing query are on searches effectively that fall into this category or sort of specifically they spend about 70% of their time searching and not finding any results so they're basically looking through logs that don't match the query expression um this ends up being because of the sort of commonality of using your you know Loki was built for operators and developers but um is used a lot by lots of other business functions and you know we call this kind of a support style business function where you know I mean this is also something that developers and operators do too um but it's more common applied in this way where folks don't really know how to narrow their search down like they maybe don't know anything about the infrastructure so they're not really good at picking labels uh they don't really know the time frame plus or minus maybe even a day or a few days and uh that can be hundreds of terabytes of logs for large customers um and you know Loki's good at what it does which is you know brute forcing these types of logs but uh you know when your volumes get to be that big the economics of brute forcing that aren't really quite as good as they are for lots of the other types of queries Loki does so so augmenting those kinds of searches with these really you know space optimized Bloom filters which have this really nice feature of being um confident in telling you where not to look so it's I don't know if a negative index is the thing you would say for something like this but the idea is we can now save ourselves from looking and that significant query time where uh there was no result to be found in the first place um they can false positive then we'll go search and then you know be able to do the filter uh but that's you know that false positive rate is tunable and you know single digit percentage um so this can you know have a huge uh impact but uh we are still you know working hard at making it better the you know core pieces of it will be in 3.0 so you'll be able to play around with it it's not going to be production ready um not for I don't know maybe another month or so you know stay tuned there um very excited though be a sort of a big asset to a common use case that we see with Loki yeah I think the the part that I'm most excited about here is that it's um configuration L right so there's like no external complexity that kind is kind of forced on users it'll just take the queries that are sent to Loki that use filter expressions and it will just automatically test for those things um so that was probably the the biggest challenge here was finding a way to be able to do query acceleration which is traditionally done via VIA indexing in some form or another um and do that in a way that wouldn't require us to introduce schemas and kind of violate that kind of core principle of Loki which is you know we just operate on on a list of bytes and don't really introspect you know what's inside until you know the user tells us to so yeah anyways very excited about it um we'll be will be fun to to kind of reveal yeah um so the next thing on this list here is is sort of new um I'm looking now we're not I don't think I can show you though I wanted to show but I think we've decided that you're gonna have to uh watch a graphicon presentation um to see a demo of what we're calling explore log so uh what this is I guess at least what I'm going to call it um although I'm not primarily the I'm not the expert here so apologies if we end up rebranding this a bit but um this is a essentially a querist experience for using your log so uh you know one of the things that's a kind of recurring theme as Loki's adoption grows and we grow from you know being like PR metheus but for logs where our user base is familiar with a query language you know promql which Loki is largely patterned after and these concepts of labels um you know to a world where folks are maybe not using Prometheus at all you know that the have lots of vogs but don't have Prometheus as a metrics database or um don't know about the infrastructure labels and and aren't interested in learning and even if they were sometimes discoverability here is hard so so this is a user experience that lets you um navigate your infrastructure without having to type a query so uh doing some really nice things including you know recognizing patterns and log lines and displaying them you know the the key value pairs parsing your log lines in order to show you you know very quickly individual graphs for each element of the log line itself uh lot of really cool stuff here maybe I can sneak a screenshot in here in a minute at least to to to show you what it looks like but we're really excited about this because there's a whole world of folks out there that you know are not particularly interested in learning another query language um you know I can understand that uh the Loki Cory language is interesting like a lot of things how it's developed over time some aspects of it are really good some of it needs some work but if we can sort of engage with folks in the platform without having to have a query language at all think that's a big win as well so I don't know if anybody joined that was working on this more closely that has anything to add to that or if we can kind of move forward to think that's good all right um all right so next exciting things um the the feature here that we're releasing in Loki is really called structured metadata however the part that I think most folks care about is that it allows for Loki to have um a native otel ingestion endpoint in a much better open Telemetry open open Telemetry uh user and query experience so if you've tried to use Loki with open Telemetry now and you use the open Telemetry collector um what happens is this metadata that exists on open Telemetry lines um is sort of more expansive than what Loki was built for Loki was built for very minimal amounts of metadata and they go right into the index so just you know a few key value pairs to identify your logs so we didn't have a good solution for that and what ended up happening in The Collector was that metadata gets serialized into the log line by basically wrapping the log line with another Json wrapper with that metadata and then at query time you have to you know parse it with Json and to sort of unwrap that um but now Loki has a place called structured metadata for this additional metadata so this is for data that basically does not exist or belong in the index um maybe it's high cardinality maybe it just doesn't even make sense to index it um but also doesn't really belong in the log line either because it's not log content it's metadata so now we have started metadata that's where all the open Telemetry uh Associated resources and attributes will go and because it's being stored separate from the log line now when you run your queries you'll just see the log line um but also get that attached metadata and this should create much better experience for those using open femry as well as um Loki itself in three. has native um OT LP end points so you can just write OT LP open Telemetry line protocol directly to Loki pause if there's any other questions or feedback I think this is a really cool one because it um kind of the first stage of us natively supporting open Telemetry in a lot of parts in the you Loki experience right so mainly focus on ingestion here right there's there's still going to be some work to do to um find better ways to expose this to uis and things like that but it's um just being able to automatically send us stuff is is a really really gooder and that you can obviously still query and everything it's just we'll need to build up better uis that that kind of natively understand obry concepts of the users don't have to write queries to do that um all right so last sort of you know my focus for the last uh month or so has been all in the world of Helm charts um can't say that I'm still much of a fan of Helm but I am at least a lot better understanding it and sort of empathizing with the folks that use it um it is kind of the deao way to run stuff in kubernetes um you know historically weave and still internally use something called jsonic but that does not have much adoption so we've always had this world where we're kind of you know a bit fragmented with how we run and configure Loki versus how everybody else does it so we're closing the Gap now the Helm chart is it's been updated to support the on microservices deployment mode um building in mcash uh is part of the deployment the configs the things that we're running um how we're configuring Loki are all being sort of pushed into the helm chart our goal is to actually internally um replace our operations using of using jsonic with Helm um this tool that we built called Tonka has the ability to vendor and deploy hel charts it's really nice it's actually a really nice way to use Helm um if if you're not familiar I would check that out um one of the things that Helm kind of frustrated me with its lack of sort of built-in diff support and and I don't know just the sort of life cycle that it follows I find a bit frustrating so Tonka is kind of maybe a nice way to but we're not here to talk about Tonka just talk about how much the helm chart has been improving so it now can support running Loki in a single binary what we call our simple scalable deployment mode which is a Middle Ground between microservices and single binary all three of those are in the chart they can be separately configurable you can move between them um I gotta write docs for that still but the goal here is for us to try to finally deprecate the other four five Helm charts that have been created over the years and have just one that we're using that you know we can keep building a better experience around um so I wanted to and I still I'll post the link to it here um my goal was to have like a release candidate and some docs and stuff for folks to be able to test out because the last part of this um is um there's a lot that's changing in 3.0 around kind of some internal so as a major release we are taking the opportunity here to break some stuff um mostly just well mostly configs and some metrics so there's a long history of how Loki got where it is today and as a result it's had a lot of metrics that have like a cortex prefix in them or don't have a Loki prefix so we've fixed I believe all of those um updated a lot of defaults removed some code that um maybe should have been added in the first place um we're we're also doing something now too which is um a bit of a shift for the project but the reality is we can't support we're just at the limit or beyond the limit of what we can really support in terms of the way Loki runs and operates so you know the very early days Loki used to have a dependency on um a third party index like Dynamo DB or big table or Cassandra um it's been several years I mean nearly three years or more now since we've run Loki with any of those types of external index the bolt DB shipper index replaced them like I said more than three years years ago now um and then tsdb has superseded that which is similar model of you know Loki has its own index and moves it in and out of object storage so we are deprecating support for Cassandra big table Dynamo DB um we didn't remove any of the code yet probably won't happen until we'll say 4.0 but at this point it's it's been so long since we run Loki with anything like that all of the new features Bloom filters deletes line deletes um tsdb and its ability to do Dynamic sharding like all of that stuff only works on the tsdb index so if you are using those external indices um I'm sorry to say that those sort of you know support for that has kind of come and gone and ultimately those code passs will be removed like I said not super soon I would say probably another year but um it is long past time for everyone to upgrade to tsdb as their index and also b133 is their schema because that's where all of the new development is um so as that you know related to that there's a few updates within 3.0 some config changes we had to move around that unfortunately weren't easy to do without just forcing a Break um so you more likely than not might need to make a couple changes to your config file to run 3.o we got a big long upgrade guide that's going to detail that as as best we can um but yes the good news here I mean I I apologize for you know the experience but what we're trying to do is set ourselves up for the next five years of success Believe It or Not Loki is more than five years old now it's fiveyear birthday was in December um I believe it's actually well that was from the sort of initial announcement of it as a project but um so now we're trying to set ourselves up for you know long-term support and maintainability and stability of the project lots of new features to come come for sure but um 3.0 I think is a big milestone in the direction of like having a much more opinionated tool in terms of how it's built how it's run how you should operate it how we operate it and hopefully all of that makes it a lot easier for everyone to use um yeah well put thanks I'm like man I feel like I've been talking for couple minutes now yeah better you than me uh so that's that's all I had um I got a whole bunch of breaking change PRS to go merge if we don't have anything else to talk about or uh I will have so I I'll post it here I don't know what I'm G to do with it yet but um there's in the community slack I made this channel called Loki 3 turns out you can't do a DOT and a slack channel name so that's not Loki 3.0 [Music] um I started I had all kinds of great intentions here about what I could have done and when um created this um and I if you were willing to go sort of you know try installing it you're sort of St like what's missing here is what I'd like to have at least is if you're using the Loki distributed Helm chart which I believe is probably one of the most you know widely used Helm charts it's a community built and supported chart I want to replace it with the Loki chart and its new distributed mode and there should be a way to migrate between those charts but don't have the instructions for that yet um it's always gonna be a bit tedious because Helm you know you this isn't necessarily Helm's fault like you can't sort of change the ownership of a stateful set or a deployment between charts so it'll be a function of ESS installing both charts at the same time and scaling resources up and down um as long as the you know both installs have the same member list config they'll join the same cluster and you can kind of scale one up and scale the other down so I want to put some docs together for that because I don't think that's going to be too hard for folks and then they can be um on this chart which has more opinions and better opinions around running Loki um but my goal is to I'm going to try to we have a kind of a release candidate in built now I I don't know what I'll have to publish try to find something some images that we can push out that folks can test because I guess I'm looking for feedback on What's Missing from our upgrade guide like where you know lots of configs out there lots of folks having run Loki and configured it from years ago that maybe there's a config that we didn't account for on the upgrade guide and kind of looking for feedback to help make sure everybody's experience is as smooth as we can make it um yeah anybody I want to stop sharing for just a [Music] second and then I'm gonna reshare so uh I do this real quick you're gonna get a real quick Peak was told that this is okay so this is what the new Explorer logs app looks like what we're looking for here is a way to make it really easy to be able to see what labels that are on your logs be able to do quick things like say only show me errors um you know from my errors be able to say like you know what errors are the most common let me go back a little bit here too far oh now you get it in light mode and this is a really really cool thing to pattern features be able to like look at the different patterns of log lines and exclude them so like you know these commonly occurring patterns exclude them from your search to be able to narrow down specific types of things again detected Fields being able to quickly see this is the sort of you know rough idea that's all you get if you want to learn more uh check out graan con check out the presentations at graphicon check out Loki 3 you probably need a very new version of grafana I don't think that the code that's in this is going to ship in whatever the most recent release grafana is but we'll find some instructions somewhere but pretty excited about this too there will be instructions in the read me you need Loki 3 and gron 11 okay all right yep sounds good any questions or comments no going once going twice awesome thanks everybody looking forward to getting all this ready and having it out available early next week take care bye thanks Ed

