# New TraceQL metrics features in Grafana Tempo 2.4

In this video, you'll see a deep dive demo into the experimental TraceQL metrics feature in Grafana Tempo 2.4. We'll show you ...

Published on 2024-02-29T18:48:18Z

URL: https://www.youtube.com/watch?v=EYUx2DkNRas

Transcript: hey everyone it's Joe Elliot a lead for Tempo and today we're going to be talking about a bunch of new features in Tempo 2.4 okay first we're going to start with this empty query so we've all seen this query before uh this query will just return everything it asserts no conditions it'll find every Trace but what we have that's new is this rate function so Trace skill metrics are experimental in 2.4 and uh we currently have only support for rate so we can see here a series of like synthetic data it's spiking every few minutes and we see spikes up to about 1.5k spans per second and we're seeing like a baseline around 3400 um so we have the ability to show rates and to do aggregation Group by let's see what services exist in our data set um and we can see we only have three services again this is kind of synthetic data uh but we have three services and we can see uh the server mythical server here is spiking to about a thousand and some of the other components are just composing less of the data so a simple rate function off of our empty query but we have the ability to see what services are producing these spans um as well as the ability to do different kinds of fun grouping so we did service name we can do span name and we can do literally any attribute uh in our data set could be right here let's use this feature um to do uh two things I'm going to search for errors which I think is pretty standard uh we have data we have this observability data one of the primary cases of course is to find errors so first I'm going to find these errors and then I'm going to do two things I'm going to both uh search for root cause I'm going to dig down into the tree the trace tree and I'm going to search for impact I'm going to go up the trace tree to see what uh What uh spans what end points we are impacting uh by increasing their error rates so I looking at these errors right here and I see I have three spans that are in error I have this database I have an endpoint um and I have this requester we can use tempos structural queries to kind of determine what's causing what we're going to look up and down this tree and the first thing I'm going to do is I'm going to say okay for a status error uh what are the uh what are the end points above this error so let's do a span Dot and I'm going to look for in particular uh spans with a HTTP route where they're not equal blank so I'm looking for any spans above an err that uh have a route and this is showing me that at the moment only one of my end points is negatively impacted so I can see these spikes every few minutes uh about eight spans per second are an error and they're above some other error and I Can See Clearly what it is it's this particular endpoint post SL endpoint I can see what service names I can use this information to very quickly look above an air to figure out you know am I impacting one end point point one service am I impacting 5 10 a thousand are these critical end points that I need to you know raise an alert for or are these kind of end points that we can uh ignore till Monday kind of situation right so this query is looking for errors and then it's looking for any uh HTTP routes above that error that might be impacted I'm able to see some spikes on this end point here post SLO maybe I'm concerned maybe I'm not so let's do the opposite we just looked at the impact of this error let let's look at root cause so if I have an error and it's at my HTTP route let's actually change this to be what I had a second AG right let's do my SL endpoint let's flip the query now we're going to use an operator to look for errors somewhere beneath so before we were taking an error um and we were looking for the end points above that were impacted and now we're taking an error at an end point and we're looking down the tree to find why or what is causing the errors of my endpoint and we can see clearly that this postgress instance is failing in concert with my endpoint so I'm looking at my endpoint my failed endpoints I'm looking for any errors beneath it and I'm grouping by name and service name so I can see that the mythical server uh is failing somewhere beneath my endpoint anywhere in the tree and I can see clearly that this postgress insert is the problem uh we can do other kind because this is you know trq because we can access all of our attributes we can look at the database name uh we can see if this a lot of databases are one I can see okay now it's just a single database that's having issues that's might be comforting perhaps or at least it you know constrains the scope of my issue and we can do by statements so I can see what kinds of statements are failing so right here I can clearly see I have insert statements that are failing see they're about failing failing at about the same rate so maybe not related to a single table maybe this is related to inserts uh generally at this point I know a specific endpoint is failing I know a specific database is failing along with it somewhere down the tree I know the name of the database and I know it's all inserts I can maybe use this information to uh you know go Target and very specifically look at the database look through logs maybe the inserts in particular or a clue that tell me what's happening but I was able to achieve all of this only by executing Trace ql queries I haven't even looked at a trace yet I've never looked at trace results I've not clicked and dug through a trace and all of this was you know achievable learnable by typing these metric qu iies um and getting results back there uh so I think root cause analysis as well as impact analysis is going to be huge with Tempo uh again experimental in 24 Looking to GA and 25 I want to show just some other ideas as well uh just to show off kind of the flexibility of the language and the the application but maybe something that's interesting to me is um uh requests between two different applications maybe I want to count the number of times one service calls another service this might actually be hard with metrics maybe my metrics don't support the cardinality required to um uh to easily show all services that are connected to all other services but I can um do that with Trace quite easily so I'm asking for how many times does the requester call the server oh actually let me switch this to a child um it should be okay roughly the same but we're saying how many times does we do we cross the service boundary from this service to this service and just show me the rate so it's a very kind of like ad hoc question you're sitting and you're wondering how many times does my one application call this other application my metrics don't quite support that I'm able to instantly determine that through Trace ql metrics and I thought about this one also I thought this one was clever a lot of times uh we a lot of times we struggle to know the impact of our of our applications Downstream on all the different things they call you Call one uh application and it calls three and then it calls 10 and you're single API call turns into 5,000 or 10,000 you don't have Vision on that so something like this will show us the rate oh uh yeah the rate of database calls beneath my application uh in any in any of the descendant applications so maybe I have three or 10 or 15 dependencies and I want to know what is my impact on relational database across the entire company I can ask that question by saying okay resource service name descendant and show me all spans that access a database and then give me the rate of those please I can of course rate these by uh the type of query I can rate these by the databases that I'm accessing I can rate these by the service that is downstreaming me somewhere accessing a database um the options are kind of endless let me look at statement real fast for some fun and I can see downstreaming me what are all of the all of the different uh SQL statements across all applications I'm calling and Trace ql and Tempo supports that okay so uh excited for Q metrics there's a lot of cool things on the horizon we just have right now obviously I think quantile is next as well as some other features and expect this to be GA in 25 we're just rapidly working on features as well as performance improvements um but you can use this right now with grafana 11 and Tempo 24 uh so as you can see here we both did root cause analysis which is one powerful way to use your traces to go down the tree as well as impact analysis to go up the tree uh and finally a couple hot queries for fun to show the power of being able to ask questions of your Trace structure to learn about your applications cool all right uh you all take care and I'll see you in Tempo 25

