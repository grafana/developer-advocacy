# Creating an OpenAI Powered Panel Plugin for Grafana | Grafana for Developers

Learn how to create an OpenAI powered Panel Plugin for Grafana that can analyse the contents of your dashboard and provide ...

Published on 2024-06-11T08:00:24Z

URL: https://www.youtube.com/watch?v=fOF-SmDU9zo

Transcript: hi I'm Tom one of the senior developer Advocates here at grafana labs and in today's video I'm going to be showing you how you can create a dashboard panel plugin for this example we're going to create an open AI analyzer tool which can take a look at the contents of your dashboard and then give you an analysis of what it thinks it can see this could be useful for all sorts of use cases such as accessibility forecasting debugging and just getting General insights into the contents of your dashboard the first thing we're going to do is create our plugin itself using the create plug-in CLI tool to do that we're going to type npx at grafana DC create plugin and then we're going to give it the latest version here you'll see that it asks us if we're ready to install this package and proceed we're going to say yes and now it's going to ask us a series of questions to determine what kind of plugin we'd like to create so the first thing it's going to ask is what the name of our plugin is I'm going to call this one open AI demo next it's going to ask for the organization name I'm just going to give it the name Tom Glenn and then how would I describe my plugin an open AI demo plugin next it's going to ask us what kind of plugin we'd like to create within grafana there are four distinct types of plugins that you can create these being apps data sources panels and then the new modern scenes apps for now we're going to dive in in and use the panel option here next It'll ask us if we want to use the GitHub CI and release workflows I'm just going to say yes to this and then again do we want to use the GitHub workflows for automatically checking whether or not the graphon apis are compatible on our PRS we're going to say yes to this as well and what this is going to do is it's going to scaffold our plug-in directory for us and include everything we need to get started quickly you can see here that it's given us a bunch of instructions for how to navigate to the directory install all of the approp packages and then run our grafana development environment which will have our plugin provisioned for us automatically so let's do that now I'll change into the directory here which is my organization name followed by the plug-in name followed by the plugin type so open AI demo Das panel and then what I'm going to do is I'm going to run mpm install to install all of the necessary packages here okay now that all of our packages have been installed I'm going to build it by using mpm run Dev this is going to use webpack to build all of the files within our plugin and then monitor them for any changes so that when we're making changes in the future the plugin will automatically be reloaded within Agra finer development environment let's open a new tab of our terminal now I'm going to navigate back to the project directory here so it's Tong Glenn open AI demo SL panel and now I'm going to run Docker compose up with the build flag and what this is going to do is it's going to use a Docker compose file which is in the root of that plug-in directory to spin up a development environment of grafana which has already got our plugin provisioned and ready to go now that we have our development grafana instance running we can open it by heading over to our browser and coming over to Local Host Port 3000 you'll be presented with the familiar grafana home screen and what I'm going to do is come over to the menu on the left hand side here come down to Administration and go to plugins and data there I'll select the plugins option and from within the list I'm going to search for my plugin which was called open AI you can see here the open AI demo by Tom Glenn I'm going to click on it and you can see here now that it says that this is installed I can uninstall it here but it's already installed you can also see that it is unsigned all plugins within the grafana ecosystem must be signed before they can be published but in our case our development instance of grafana is able to run this specific plugin while it's unsigned during development process so what I'm going to do now is come over to the home screen here come back into our dashboards and I'm going to create a new dashboard you can see a dashboard has already been provisioned for us here but I'm going to create a brand new one here so let's go to new dashboard I'm going to save this I'm going to call it open AI plugin demo dashboard let's save that and then I'm going to come to add visualization we'll just use the test data uh data source there and then I'm going to create the open AI demo panel let's choose that and you can see that for now all we have here is a circle with some text at the bottom here let's give this a title I'm going to call it AI analyzer and for now let's just apply and save the changes there okay so this panel is now running on our graphon instance and what we're going to do is we're going to change the code for this particular panel so that we can use open ai's API to analyze the contents of whatever is on our screen currently so we're going to need to do a couple of things here first of all let's open up the code and have a look at the structure of a plugin okay so I've opened up our plugins folder in vs code here and you can see in our folder structure we have a bunch of configuration files that determine things such as our G configuration for testing our typescript configuration readme Docker composed file and so on the thing that we're interested in is inside of this Source folder here so let's expand this and you can see that inside of this we have a plugin. Json file let's open that and have a look at the contents you can see that it has a schema here it's got a type of panel now this is because we chose the panel plug-in type if we we chose app for example it would be type of app we've got our name for our plugin an identifier for the plugin and then a bunch of metadata here that determines who created the plugin what the description is all of the information that you saw within that Administration plugin section you can also see that we have a specific dependency on a version of grafana so if you wanted to support an older version of graffan you can come in and change that here as well as any plug-in dependencies if your plugin in particular depends on another plugin then you can Define that here and what that means is whenever someone installs your plugin any dependent plugins or plugins that yours depends on will be automatically installed into your grapher instance as well let's now come over to our module. TS file inside of this module. TS file is where we're defining our particular panel plugin you can see here that we're creating a new const plugin and it is of type panel plug-in with a simple options type here which determines what configuration options this particular panel type will have then we're going to use this Builder object to Define all of the different configuration options within our panel so you can see here there's a few different configuration options being added we have a text input called text we have a Boolean switch called show series count and we have a radio option called series count size and these individual objects Define various things such as what the default value is what the name is that will be displayed inside of the configuration panel in graffer itself and all of the different options available and you can also have conditional rendering here so for example this radio option this series count size will only show if the show series count Boolean switch here is enabled let's dive over to the grafana configuration for our panel now and show you what that looks like in practice if I come on over to our panel here click on the drop- down option here and press edit on the right hand side here you'll see that we have this open AI demo section within our dashboard you can see that we've got the simple text option it has a default value there and then we have this show series counter Boolean checkbox here if I check this then the series counter size option is now appearing because of that conditional show if statement and from here we can select different options for this for our particular plug-in purposes we don't need any of these configuration options however what I am going to do is create a configuration option to allow the user to enter their own open AI API key now for a production plug-in you would probably want to use some sort of backend to communicate with open AI on your front-end panel's behalf so that you're not exposing this API key in the front end however for this demo I'm just going to put the API key in the configuration options of the panel itself so let's come back over to our code and what I'm going to do is remove the Boolean and the radio options here so let's take those out of here and then for the text input I'm going to change the path here I'm going to call it open AI API key I'm going to give it a name of open AI API key and then for the description your open AI API key and we're going to get rid of this default value because we don't need that in there let's save this and now what I want to do is come over to our simple options type here and make sure that we have defined a variable for our openai API key so let's copy the path value there and now I'm going to come over to the types. TS file on the left hand side and you can see here that we've Define some types for the configuration options for this particular plug-in here's the series size that was being shown in the series size radio option before I'm going to get rid of that because we no longer need that and then for our interface simple options here we can get rid of the series size counter and the show series count and for our text option here I'm going to give it the name of open AI API key and it's still a string so we can leave that as is let's now save that and come back over to our dashboard here and you can see that automatically without having to do anything on the right hand side here here our configuration options have changed and we can now see that we have our open AI API key it's got our nice description there and we have a text box where we can paste that in before we move on then I'm going to paste in my open AI key here and I'm going to apply and save the changes to this dashboard now what I want to do is go back into our code for our panel and I want to make some changes to the visual elements of this panel here so you remember before we had that circle on the screen and some text at the bottom this is defined within our components folder here so if we open up the components folder you can see we've got this simple panel. TSX file so inside this simple panel. TSX file you can see that we have a react component here we're getting our props from our simple options type here we've got a style definition here that defines what the component itself is going to look like like and then we have our simple panel component itself which is a react. fc component at the top here we're getting the current theme and then we're grabbing those styles that were defined up here and they're going to be used down in our react component later on as we return this from the function you can see here that what we're doing is checking whether or not the data series length is equal to zero and if it is we're going to return this panel data error View and that's just going to show up in graph to say there's no data to show but in our particular panel instance we're not interested in showing any data from any data source queries so we can get rid of this we're simply creating a panel that is going to be a tool on the dashboard itself and then inside of our return statement here for this react component you can see that we're defining an SVG and here we have this circle and that's simply displaying that Circle within the panel itself and then also we have this text here at the bottom that displays some information about the number of series I'm going to remove all of this here because we're only interested in showing a input button so that we can analyze the contents of our dashboard so let's save this and quickly flick back over to our dashboard and you'll see now that the entire panel is blank because we've removed that SVG and we've removed our text at the bottom there so for this particular plugin what we're going to need is access to the open a SDK we can do that by installing the open AI mpm package we're also going to make use of another package called HTML to Canvas and what that's going to do is allow us to take a screenshot of the current dashboard that we're on and we're then going to upload that to open aai and ask openai to give us some insights into what it can see so let's open up our terminal here and we're going to install those two packages so we're going to say mpm install first one is open Ai and the second one is HTML to Canvas let's let those install and now at the top of our simple panel here I'm going to import both of those packages we can remove this panel data error here cuz we're not using that anymore but let's import our open Ai and we're also going to import the HTML to Canvas so let's save that and now what I'm going to do is I'm going to grab some Styles here and I'm going to change our const get Styles I'm just going to paste in some styles that I've pre-written just to make this tutorial a bit easier and all this is going to do is add in some CSS classes that we can use within our component to make it look nice so let's save that and now down here inside of our simple panel we're going to remove this Con theme we're no longer using that but we are going to define a couple of things here first of all I want to Define some prompts that we can give to open AI that will allow us to Define how we want open AI to interpret the screenshot of the dashboard that we're going to pass to it so I'm going to pull in some analysis options here and you can see this is a const called analysis options it's a map of string values and we've got a few different ones here so we have summary insights accessibility diagnosis comparison and forecasting feel free to add your own or modify these in any way that makes sense but each of these basically contains a prompt that is going to be passed to open AI so you can see here for the summary one we say this image shows a grafana dashboard only focus on the panels on the dashboard do not include the AI analyzer panel provide a brief summary of what the dashboard is displaying focusing on the most critical and relevant data points lighter colors on heat Maps indicate higher usage darker colors indicate lower usage always start with this dashboard shows and ensure that the summary captures the key insights without going into too much detail and you can Define like I say any number of prompts here that you want to use for this particular plugin next I'm going to create our open AI client we're going to do this by saying const open AI we're going to say new open Ai and then we're going to pass it our API key so here we've called this our open AI API key and we're also going to pass in this dangerously allowed browser True Value as I said before in a production environment you typically wouldn't call this from the front end itself because this could potentially expose your open AI key to any body that is accessing your web application you would probably use a backend to communicate with open Ai and then have your front end communicate via that however for this particular example like I say we're just going to use this option here as it makes life a little bit easier when demonstrating a front-end panel plugin next we're going to create a series of State variables here to use within our react component couple of different things here we have the button text that we want to display on the button we want a button enabled value to determine whether or not the button can be clicked right now we want our analysis text which is going to determine which prompt we want to use we're going to have a narrate variable here that determines whether or not we want this plug-in to speak use text to speech to actually speak the analysis we're going to have a selected option value which is simply going to determine which option the user has selected from the dropdown and then we're going to have the prompt itself which is going to determine which prompt is being passed to the open AI endpoint next I'll add a couple of Handler functions that can handle when our options drop down changes and here we're going to grab the value of our options here we're going to use the set selected option in our state component here for selected option we're going to pass in the new selected value and then we're also going to call the set prompt function here again this is using our prompt use State command here this is going to pass in the appropriate prompt based on our analysis options and what the selected option is from our dropdown in the handle checkbox Change option here we're simply going to change whether or not we want the narrate variable to be true or false depending on the current checked state of the checkbox in our component next I'm going to define the function that handles when the analysis button is clicked so let's dive into what all of this does first of all when the button clicked we're going to set the button text to be analyzing and then we're going to disable the button here so that it can't be clicked a second time next we're going to use our HTML to Canvas plugin here to take a screenshot of the entire document using document.body we're going to Define use cause as true and we're going to disable the login just so that our console output isn't cluttered there next we're going to turn the image the screenshot that it's taken of our web page and we're going to turn that into a data URL we're going to Define that we want this to be in PNG format and then we're going to call out to the open aai chat completions endpoint we're going to say that we want to use GPT 40 the latest model we're going to give it a messages object here we're going to Define that we want the role to be user and then we're going to pass it some text here so for our text we're going to pass in the specific prompt that we defined earlier that was also selected by the user choosing the appropriate selection box and then we're going to pass in an image URL and for this we're going to pass the data URL so this is the two data URL option here that we defined we're going to pass that over to chat GPT as well once we've got our response we're going to get the content of that response and that's the text content that GPT has generated and we're going to set the analysis text to be that response there and this is going to then show up within our panel plugin within a text area if then the narrate option is enabled so if narrate is true we're going to change the button text here to be generating audio just so that the user has some cue as to what's going on because this may take a few seconds and then what we're going to do is use open AI to convert the text response into a speech response you can see here we're using the tts1 model we're choosing alloy as our voice and then we're passing in the response content that we received from GPT before next we're going to turn this response into an array buffer and we're going to create a new blob of type audio EG and then we're going to use an audio component to play that audio and finally what we'll do is set the button text back to analyze we'll reenable the button and if any errors happened we'll just log those out out to the console there the last thing for us to do here is change the HTML structure of our react component to accommodate for the buttons and options and text output that we want to display so let's replace this return statement here and you can see that what we have is a wrapper div again this is using our Styles wrapper CSS class we're using the width and height of the particular panel and you can see this comes from the width and height props that are being passed into our panel itself and then we've got a couple of things here we have our selection dropdown option which is simply iterating through all of the analysis options that we defined earlier and creating a drop-down selection option for that we then have an input checkbox which is going to define whether or not the narrate variable is true or false and then finally we have a button here which is going to display that button text and it's going to call that on button click function the last thing we have here is our analysis text so we're going to Output our analysis text if it exists and you can see here that we're using the react markdown component so we're going to need to install that package as well we can do that by coming into our terminal and type in mpm install react D markdown then once that's installed at the top of the file we're going to import react markdown from react markdown let's also remove this used theme to as that's no longer used within our code just to tidy that up and let's save this file one last thing we're also going to need to do if you were Keen eyed and spotted the mistake here is that we didn't import the use State function from our react package so let's do that quickly and now save the file and what we can do now is we can switch back over to our dashboard here and you can see that our plugin has has updated we now have our drop- down option where we can choose the different prompt type that we want so for example accessibility we have a tick box that determines whether or not we want to narrate this and then we also have the analyze button here before we try this let's update our dashboard so that we have some example panels for our analyzer to actually work with let's first of all make this panel a little smaller and a little taller and then we'll add add a new visualization here and you can see here that we're using this test data database Source it's using the random walk scenario to generate some random information here and what we're going to do is make it look like this is some CPU usage data so let's change the panel Title Here to CPU CPU usage percent and then I'm going to scroll down and I'm going to come down to uh Min and Max values here and change this to zero and 100 and then let's change the unit here to percent 0 to 100 and then we will apply that let's make this a little bigger and we'll move our AI analyzer component over and now let's create another panel as well another visualization this time I'm going to change the scenario here in our test data source to be the exponential heat map bucket data and I'm going to change the visualization here to a heat map and this is just going to give us some different interesting kinds of data to work with here let's change the panel to CPU core usage and then we will save this as well let's make it a little bigger let's maybe flip these around a little bit here and we'll make this one a little bit smaller and we'll make the analyzer a little bit taller here let's save this dashboard we're going to say added example visualizations let's save that and now what I'd like to do is come over to our analyzer here and we're going to choose one of these options so let's stick with summary for now and let's see what output we can get we're going to keep narat as enabled because we want this to speak the analysis to us and then we're going to click on analyze and see what we get this dashboard shows the CPU usage over time and the detailed CPU core usage the line graph at the top represents the percentage of CPU usage for the a series which shows a general decline from around 25% to around 15% over the displayed time range the heat map below illustrates CPU core usage where lighter colors indicate higher usage and darker colors indicate lower usage the heat map reveals varied activity with noticeable periods of high usage scattered across different times and cores with some concentration of higher usage around 0615 730 and 0915 notably there are also some periods of lower activity throughout the time range okay so you can see that it took a screenshot of our dashboard here it uploaded that to open aai which has then been able to analyze the contents of this and then give us a summary of what it thinks it can see let's now try changing this option here from summary and we'll choose something a bit more useful such as accessibility for example and let's see what we get back for that okay so you can see this time we got a little bit more detail here so let's see what it has to say once it's generated the audio this dashboard shows the CPU usage over time and the detailed CPU core usage panel one CPU usage scent purpose this line graph displays the overall percentage of CPU usage for a specific series referred to as the a series y AIS vertical represents the percentage of CPU usage ranging and you can see now that it's giving us a lot more information and it's describing it in much more detail in an accessible way because we change the prompt that we're passing to open AI there and so there we have it that's a quick and simple demo of how you can create a panel plug-in within grafana and specifically how you can utilize thirdparty mpm packages to do various custom bits of functionality within your panels panels don't just need to be visualized in particular bits of data they can also be utility functions just like we've created here today with our open AI analyzer plugin in future content we'll look at how we can create data source plugins as well as app plugins and the new scene plugins as well I hope you found this video useful if you did make sure to leave a like And subscribe for more grafana related tutorial content in the future until next time take care

