name: Fetch YouTube Transcripts

on:
  schedule:
    # Run every Friday at 8 PM UTC
    - cron: '0 20 * * 5'
  workflow_dispatch:
    inputs:
      limit:
        description: 'Limit number of videos to process (leave empty for 10)'
        required: false
        type: string
        default: '10'

jobs:
  fetch-transcripts:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Prevent hanging workflows
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Cache Python dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('transcripts/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        cd transcripts
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Create .env file
      run: |
        cd transcripts
        echo "API_KEY=${{ secrets.YOUTUBE_API_KEY }}" > .env
        echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env
        
    - name: Fetch transcripts
      id: fetch
      run: |
        cd transcripts
        
        # Set limit with fallback
        LIMIT="${{ github.event.inputs.limit }}"
        if [ -z "$LIMIT" ]; then
          LIMIT="10"
        fi
        
        echo "Processing up to $LIMIT videos from Grafana channel"
        echo "Limit: $LIMIT" >> $GITHUB_OUTPUT
        
        # Run the transcript script
        python3 transcripts.py -l $LIMIT
        
        # Count new files created
        NEW_FILES=$(find . -name "*.md" -newer ../.github/workflows/fetch-transcripts.yml 2>/dev/null | wc -l || echo "0")
        echo "New files: $NEW_FILES" >> $GITHUB_OUTPUT
        
    - name: Check for changes
      id: check-changes
      run: |
        if git diff --name-only --exit-code transcripts/*.md; then
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "No new transcript files found"
        else
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "New transcript files found:"
          git diff --name-only transcripts/*.md
        fi
        
    - name: Commit and push changes
      if: steps.check-changes.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add transcripts/*.md
        git commit -m "chore: fetch new YouTube transcripts [skip ci]

        - Processed up to ${{ steps.fetch.outputs.limit }} videos
        - Channel: UCYCwgQAMm9sTJv0rgwQLCxw (Grafana)
        - Triggered by: ${{ github.event_name }}
        - Workflow: ${{ github.workflow }}"
        git push
        
    - name: Create workflow summary
      if: always()
      run: |
        echo "## 📺 YouTube Transcript Fetch Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📊 Execution Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Workflow**: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Run ID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 🎯 Processing Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Channel**: UCYCwgQAMm9sTJv0rgwQLCxw (Grafana)" >> $GITHUB_STEP_SUMMARY
        echo "- **Video Limit**: ${{ steps.fetch.outputs.limit || '10' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **New Files**: ${{ steps.fetch.outputs.new_files || '0' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Files Changed**: ${{ steps.check-changes.outputs.changed }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ⏰ Timing" >> $GITHUB_STEP_SUMMARY
        echo "- **Started**: ${{ github.event.head_commit.timestamp || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Timeout**: 60 minutes" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.check-changes.outputs.changed }}" == "true" ]; then
          echo "### ✅ Success" >> $GITHUB_STEP_SUMMARY
          echo "New transcript files have been created and committed to the repository." >> $GITHUB_STEP_SUMMARY
        else
          echo "### ℹ️ No Changes" >> $GITHUB_STEP_SUMMARY
          echo "No new transcript files were created. This could mean:" >> $GITHUB_STEP_SUMMARY
          echo "- All recent videos already have transcripts" >> $GITHUB_STEP_SUMMARY
          echo "- No new videos were found in the specified range" >> $GITHUB_STEP_SUMMARY
          echo "- Rate limiting prevented processing" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: Handle errors
      if: failure()
      run: |
        echo "## ❌ Workflow Failed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "The transcript fetching workflow encountered an error. Common causes:" >> $GITHUB_STEP_SUMMARY
        echo "- API key issues (check secrets)" >> $GITHUB_STEP_SUMMARY
        echo "- Rate limiting (try again later)" >> $GITHUB_STEP_SUMMARY
        echo "- Network connectivity issues" >> $GITHUB_STEP_SUMMARY
        echo "- Script errors (check logs above)" >> $GITHUB_STEP_SUMMARY